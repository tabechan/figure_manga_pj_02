generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  figures               Figure[]
  preBinds              PreBind[]
  licenses              License[]
  carts                 Cart[]
  auditLogs             AuditLog[]
  issuedLoans           LoanTicket[] @relation("IssuedBy")
  readRights            ReadRights[]
  volumeOwnerships      VolumeOwnership[]
  reviews               Review[]
  autoPurchaseSettings  AutoPurchaseSettings[]
  nfcTapLogs            NfcTapLog[]
  purchasedTransactions FigureTransaction[] @relation("PurchasedTransactions")
  activatedTransactions FigureTransaction[] @relation("ActivatedTransactions")

  @@map("users")
}

model Series {
  id          String   @id @default(cuid())
  title       String
  description String?
  author      String?
  genre       String?
  coverUrl    String?  @map("cover_url")
  createdAt   DateTime @default(now()) @map("created_at")

  figures              Figure[]
  volumes              Volume[]
  reviews              Review[]
  autoPurchaseSettings AutoPurchaseSettings[]

  @@map("series")
}

model Figure {
  id          String   @id @default(cuid())
  seriesId    String   @map("series_id")
  title       String
  tagUid      String   @unique @map("tag_uid")
  imageUrl    String?  @map("image_url")
  description String?
  price       Int?
  status      String   @default("unclaimed")
  ownerUserId String?  @map("owner_user_id")
  createdAt   DateTime @default(now()) @map("created_at")

  series           Series              @relation(fields: [seriesId], references: [id])
  owner            User?               @relation(fields: [ownerUserId], references: [id])
  preBinds         PreBind[]
  licenses         License[]
  readRights       ReadRights?
  loanTickets      LoanTicket[]
  auditLogs        AuditLog[]
  volumeRanges     VolumeRange[]
  volumeOwnerships VolumeOwnership[]
  nfcTapLogs       NfcTapLog[]
  transactions     FigureTransaction[]

  @@map("figures")
}

model VolumeRange {
  id        String @id @default(cuid())
  figureId  String @map("figure_id")
  volumeId  String @map("volume_id")

  figure Figure @relation(fields: [figureId], references: [id])
  volume Volume @relation(fields: [volumeId], references: [id])

  @@unique([figureId, volumeId])
  @@map("volume_ranges")
}

model Volume {
  id           String   @id @default(cuid())
  seriesId     String   @map("series_id")
  volumeNo     Int      @map("volume_no")
  title        String
  coverUrl     String   @map("cover_url")
  fileUrl      String?  @map("file_url")
  price        Int?
  releaseDate  DateTime? @map("release_date")
  pageCount    Int?     @map("page_count")
  createdAt    DateTime @default(now()) @map("created_at")

  series           Series            @relation(fields: [seriesId], references: [id])
  volumeRanges     VolumeRange[]
  volumeOwnerships VolumeOwnership[]

  @@unique([seriesId, volumeNo])
  @@map("volumes")
}

model VolumeOwnership {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  volumeId      String   @map("volume_id")
  figureId      String?  @map("figure_id")
  purchaseType  String   @map("purchase_type")
  currentPage   Int      @default(1) @map("current_page")
  lastReadAt    DateTime? @map("last_read_at")
  createdAt     DateTime @default(now()) @map("created_at")

  user   User    @relation(fields: [userId], references: [id])
  volume Volume  @relation(fields: [volumeId], references: [id])
  figure Figure? @relation(fields: [figureId], references: [id])

  @@unique([userId, volumeId])
  @@map("volume_ownerships")
}

model Review {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  seriesId  String   @map("series_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id])
  series Series @relation(fields: [seriesId], references: [id])

  @@unique([userId, seriesId])
  @@map("reviews")
}

model AutoPurchaseSettings {
  id               String  @id @default(cuid())
  userId           String  @map("user_id")
  seriesId         String  @map("series_id")
  enabled          Boolean @default(true)
  emailNotification Boolean @default(true) @map("email_notification")

  user   User   @relation(fields: [userId], references: [id])
  series Series @relation(fields: [seriesId], references: [id])

  @@unique([userId, seriesId])
  @@map("auto_purchase_settings")
}

model NfcTapLog {
  id         String   @id @default(cuid())
  tagUid     String   @map("tag_uid")
  userId     String?  @map("user_id")
  figureId   String?  @map("figure_id")
  signature  String
  timestamp  DateTime
  verified   Boolean
  createdAt  DateTime @default(now()) @map("created_at")

  user   User?   @relation(fields: [userId], references: [id])
  figure Figure? @relation(fields: [figureId], references: [id])

  @@map("nfc_tap_logs")
}

model PreBind {
  id        String   @id @default(cuid())
  orderId   String   @map("order_id")
  userId    String   @map("user_id")
  figureId  String   @map("figure_id")
  expiresAt DateTime @map("expires_at")

  user   User   @relation(fields: [userId], references: [id])
  figure Figure @relation(fields: [figureId], references: [id])

  @@map("pre_binds")
}

model License {
  id            String   @id @default(cuid())
  figureId      String   @map("figure_id")
  ownerUserId   String   @map("owner_user_id")
  createdAt     DateTime @default(now()) @map("created_at")

  figure Figure @relation(fields: [figureId], references: [id])
  owner  User   @relation(fields: [ownerUserId], references: [id])

  @@map("licenses")
}

model ReadRights {
  figureId     String    @id @map("figure_id")
  activeUserId String    @map("active_user_id")
  state        String    @default("owner")
  loanToUserId String?   @map("loan_to_user_id")
  loanStart    DateTime? @map("loan_start")
  loanEnd      DateTime? @map("loan_end")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  figure     Figure @relation(fields: [figureId], references: [id])
  activeUser User   @relation(fields: [activeUserId], references: [id])

  @@map("read_rights")
}

model LoanTicket {
  id             String    @id @default(cuid())
  figureId       String    @map("figure_id")
  issuedByUserId String    @map("issued_by_user_id")
  token          String    @unique
  urlSlug        String    @unique @map("url_slug")
  expiresAt      DateTime  @map("expires_at")
  consumedAt     DateTime? @map("consumed_at")

  figure   Figure @relation(fields: [figureId], references: [id])
  issuedBy User   @relation("IssuedBy", fields: [issuedByUserId], references: [id])

  @@map("loan_tickets")
}

model Product {
  id         String  @id @default(cuid())
  type       String  @default("merchandise")
  figureId   String? @map("figure_id")
  volumeId   String? @map("volume_id")
  title      String
  price      Int
  imageUrl   String  @map("image_url")
  badges     Json?

  cartItems  CartItem[]

  @@map("products")
}

model Cart {
  id     String @id @default(cuid())
  userId String @map("user_id")

  user  User       @relation(fields: [userId], references: [id])
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String @id @default(cuid())
  cartId    String @map("cart_id")
  productId String @map("product_id")
  qty       Int

  cart    Cart    @relation(fields: [cartId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

model Event {
  id           String   @id @default(cuid())
  title        String
  date         DateTime
  location     String
  thumbnailUrl String   @map("thumbnail_url")
  body         String

  @@map("events")
}

model News {
  id           String   @id @default(cuid())
  title        String
  date         DateTime
  thumbnailUrl String   @map("thumbnail_url")
  body         String

  @@map("news")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  figureId  String?  @map("figure_id")
  action    String
  meta      Json?
  createdAt DateTime @default(now()) @map("created_at")

  user   User?   @relation(fields: [userId], references: [id])
  figure Figure? @relation(fields: [figureId], references: [id])

  @@map("audit_logs")
}

model FigureTransaction {
  id           String    @id @default(cuid())
  figureId     String    @map("figure_id")
  purchasedBy  String    @map("purchased_by")
  status       String    @default("pending")
  activatedBy  String?   @map("activated_by")
  activatedAt  DateTime? @map("activated_at")
  expiresAt    DateTime  @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  figure          Figure @relation(fields: [figureId], references: [id])
  purchaser       User   @relation("PurchasedTransactions", fields: [purchasedBy], references: [id])
  activatedByUser User?  @relation("ActivatedTransactions", fields: [activatedBy], references: [id])

  @@map("figure_transactions")
}
